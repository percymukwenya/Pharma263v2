@model int
@{
    ViewBag.Title = "Edit Quotation";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style type="text/css">
    .bg_1 {
        background-color: green;
    }

    .bg_2 {
        background-color: gray;
    }

    .error_msg {
        color: #f00;
        display: none;
    }

    .table {
        margin-bottom: 0px;
        width: 100%;
    }
    
    /* Improve responsive layout */
    .product-section {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
    }
    
    .product-form {
        flex: 0 0 100%;
        margin-bottom: 20px;
    }
    
    .product-list {
        flex: 0 0 100%;
    }
    
    /* Add % symbol to discount inputs */
    .discount-percent-input {
        position: relative;
        width: 60px !important;
    }
    
    .discount-percent-input::after {
        content: "%";
        position: absolute;
        right: 5px;
    }
    
    /* Make the page more responsive */
    @@media (min-width: 992px) {
        .product-form {
            flex: 0 0 30%;
            padding-right: 20px;
        }
        
        .product-list {
            flex: 0 0 70%;
        }
    }
</style>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />

<div class="wraper container-fluid">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Edit Quotation</h3>
            </div>
            <div class="panel-body" id="masterSale">
                <!-- Customer and Date Section -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="Customer">Customer : </label>
                            <select id="Customer" class="form-control" onchange="blankme(this.id)">
                                <option value="">Select Customer</option>
                            </select>
                            <small id="error_Customer" class="form-text error_msg">Select Customer from list</small>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="SDate">Date : </label>
                            @Html.TextBox("SDate", null, new { @class = "form-control mydatepicker", @placeholder = "Select Quotation Date ", onchange = "blankme(this.id)" })
                            <small id="error_SDate" class="form-text error_msg">Quotation Date is Required</small>
                        </div>
                    </div>
                </div>
                
                <!-- Product Section - Improved Layout -->
                <div class="product-section">
                    <!-- Product Selection Form -->
                    <div class="product-form">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title">Add Item</h3>
                            </div>
                            <div class="panel-body">
                                <form role="form">                            
                                    <div class="form-group">
                                        <label for="SMedicine">Medicine : </label>
                                        <select id="SMedicine" class="form-control">
                                            <option value="">Select Medicine</option>
                                        </select>
                                        <small id="error_SMedicine" class="form-text error_msg">Select Medicine from list</small>
                                    </div>
                                    <div class="form-group" id="medicineDetails">
                                        <!-- Medicine details will be populated here -->
                                    </div>
                                    <div class="form-group">
                                        <label for="SQuantity">Quantity : </label>
                                        @Html.TextBox("SQuantity", null, new { @class = "form-control", @type = "number", @placeholder = "Enter Quantity", @min = "0" })
                                        <small id="error_SQuantity" class="form-text error_msg">Quantity is required</small>
                                        <small id="error_SQuantitycheck" class="form-text error_msg">Quantity Must be less than stock</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="SDiscountPercent">Discount % : </label>
                                        @Html.TextBox("SDiscountPercent", null, new { @class = "form-control", @type = "number", @placeholder = "Enter Discount %", @min = "0", @max = "100", @step = "0.01" })
                                        <small id="error_SDiscountPercent" class="form-text error_msg">Discount must be between 0-100%</small>
                                    </div>
                                    <div class="form-group">
                                        <button type="submit" id="SaleaddToList" class="btn btn-info btn-block">
                                            Add To List
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Product List -->
                    <div class="product-list">
                        <div class="panel panel-color panel-primary">
                            <div class="panel-heading">
                                <h3 class="panel-title">Product List</h3>
                            </div>
                            <div class="panel-body">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="detailsTable">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Name</th>
                                                <th>Unit</th>
                                                <th>Discount %</th> <!-- Changed from "Discount" to "Discount %" -->
                                                <th>Qnt</th>                                            
                                                <th>Amt</th>
                                                <th style="width:20px"></th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                        <tfoot>
                                            <tr>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td><strong>Total:</strong></td>
                                                <td><strong id="SSubTotal"></strong></td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <small id="error_SSubTotal" class="form-text error_msg">At least add one item</small>
                            </div>
                        </div>
                        
                        <!-- Quotation Details Section -->
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label for="Notes">Notes: </label>
                                    @Html.TextArea("SNotes", new { @class = "form-control", @rows = "2", @placeholder = "Enter Notes" })
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="SDiscount">Discount : </label>
                                    @Html.TextBox("SDiscount", 0, new { @class = "form-control", @Value = "0", @type = "number", @placeholder = "Discount Amount", onchange = "SDiscountAmount()" })
                                    <small id="error_SDiscount" class="form-text error_msg">Discount can't be empty</small>
                                </div>
                                <div class="form-group">
                                    <label for="SGrandTotal">Grand Total : </label>
                                    <h5 id="SGrandTotal" class="form-control"></h5>
                                    <small id="error_SGrandTotal" class="form-text error_msg">Total is empty</small>
                                </div>
                                
                                <div class="form-group">
                                    <input id="QBtnUpdate" data-quotation-id="@Model" class="btn btn-primary btn-block" type="submit" value="Update Quotation" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    
    <script src="~/Scripts/App/sales.js"></script>
    <script type="text/javascript">
        $(function () {
            var quotationId = $("#QBtnUpdate").attr("data-quotation-id");

            $('#masterSale').ready(function () {
                $.when(getQuotation(quotationId)).then(function (res) {
                    console.log(res);
                    
                    // Set form field values
                    $("#Customer").val(res.customerId);
                    
                    var parts = res.quotationDate.split(" ")[0].split("-");
                    var year = parseInt(parts[0]);
                    var month = parseInt(parts[1]);
                    var day = parseInt(parts[2]);
                    var ret = (day < 10 ? "0" + day : day) + "/" + (month < 10 ? "0" + month : month) + "/" + year;
                    $("#SDate").val(ret);
                    
                    $("#SNotes").val(res.notes);
                    $("#SSubTotal").text(res.total);
                    $("#SDiscount").val(res.discount);
                    $("#SGrandTotal").text(res.grandTotal);
                    
                    // Clear existing table rows
                    $("#detailsTable tbody").empty();
                    
                    // Add quotation items to the table
                    $.each(res.items, function (i, item) {
                        // Calculate discount percentage from amount
                        var subtotal = item.price * item.quantity;
                        var discountPercent = 0;
                        if (subtotal > 0) {
                            discountPercent = (item.discount / subtotal) * 100;
                        }
                        
                        var rowHtml =
                            '<tr>' +
                            '<td>' + item.stockId + '</td>' +
                            '<td>' + item.medicineName + '</td>' +
                            '<td>' + parseFloat(item.price).toFixed(2) + '</td>' +
                            '<td><input type="text" value="' + discountPercent.toFixed(2) + '" class="discount-percent-input" placeholder="%" /></td>' +
                            '<td>' + item.quantity + '</td>' +
                            '<td class="amount">' + parseFloat(item.amount).toFixed(2) + '</td>' +
                            '<td class="discount-amount" style="display:none;">' + parseFloat(item.discount).toFixed(2) + '</td>' +
                            '<td><a data-itemId="' + item.stockId + '" href="#" class="sdeleteItem"><i class="fa fa-trash"></i></a></td>' +
                            '</tr>';
                        
                        $("#detailsTable tbody").append(rowHtml);
                    });
                    
                    // Bind events to the discount inputs
                    $("#detailsTable tbody tr").each(function() {
                        $(this).find(".discount-percent-input").on("input", function() {
                            updateRowAmountFromPercent($(this).closest("tr"));
                        });
                    });
                    
                    // Recalculate totals
                    SalecalculateSum();
                }).fail(function (err) {
                    console.log(err);
                });
            });
            
            function getQuotation(id) {
                return $.ajax({
                    type: 'GET',
                    url: "/Quotation/GetQuotation",
                    data: "quotationId=" + id
                });
            }
        });
    </script>
}