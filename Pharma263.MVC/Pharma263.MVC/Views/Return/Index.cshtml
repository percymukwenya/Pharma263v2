@{
    ViewBag.Title = "Return List";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="wraper container-fluid">
    <div class="page-title">
        <h1 class="title">Returns Management</h1>
        <div class="clearfix"></div>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h2 class="panel-title">
                        <i class="fa fa-undo"></i> Return List
                    </h2>
                </div>
                <div class="panel-body">
                    <div class="table-responsive">
                        <table id="returnsTable" class="table table-hover table-bordered">
                            <thead>
                                <tr>
                                    <th scope="col">Return ID</th>
                                    <th scope="col">Sale ID</th>
                                    <th scope="col">Medicine</th>
                                    <th scope="col">Quantity</th>
                                    <th scope="col">Return Reason</th>
                                    <th scope="col">Destination</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Date Returned</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="~/Content/adminFront/assets/plugins/datatables/jquery.dataTables.min.css">
    <script src="~/Content/adminFront/assets/plugins/datatables/jquery.dataTables.min.js"></script>

    <script type="text/javascript">
        // Helper function to render return reason badges
        function renderReturnReason(reason) {
            var badgeClass = 'label-default';

            if (reason === 'Expired Product') {
                badgeClass = 'label-warning';
            } else if (reason === 'Damaged') {
                badgeClass = 'label-danger';
            } else if (reason === 'Factory Recall') {
                badgeClass = 'label-info';
            }

            return '<span class="label ' + badgeClass + '">' + reason + '</span>';
        }

        // Helper function to render return destination badges
        function renderReturnDestination(destination) {
            var badgeClass = 'label-default';

            if (destination === 'Stock Update') {
                badgeClass = 'label-success';
            } else if (destination === 'Quarantine') {
                badgeClass = 'label-warning';
            } else if (destination === 'Disposal') {
                badgeClass = 'label-danger';
            } else if (destination === 'Supplier') {
                badgeClass = 'label-info';
            }

            return '<span class="label ' + badgeClass + '">' + destination + '</span>';
        }

        // Helper function to render return status badges
        function renderReturnStatus(status) {
            var badgeClass = 'label-success'; // Default for "Completed" and others

            if (status === 'Decision Pending') {
                badgeClass = 'label-warning';
            } else if (status === 'Quarantined') {
                badgeClass = 'label-info';
            } else if (status === 'Disposed') {
                badgeClass = 'label-danger';
            } else if (status === 'Returned To Supplier') {
                badgeClass = 'label-primary';
            }

            return '<span class="label ' + badgeClass + '">' + status + '</span>';
        }

        $(document).ready(function () {
            $('#returnsTable').DataTable({
                "processing": true,
                "serverSide": true,
                "ajax": {
                    "url": "@Url.Action("GetReturnsDataTable", "Return")",
                    "type": "POST",
                    "contentType": "application/json",
                    "data": function (d) {
                        return JSON.stringify(d);
                    },
                    "dataSrc": function (json) {
                        if (json.error) {
                            console.error('DataTable Error:', json.error);
                            toastr.error('Failed to load returns: ' + json.error);
                        }
                        return json.data;
                    }
                },
                "columns": [
                    {
                        "data": "id",
                        "render": function(data, type, row) {
                            return '<strong>#' + data + '</strong>';
                        }
                    },
                    {
                        "data": "saleId",
                        "render": function(data, type, row) {
                            var saleDetailsUrl = '@Url.Action("Details", "Sale")' + '?id=' + data;
                            return '<a href="' + saleDetailsUrl + '" class="text-primary">#' + data + '</a>';
                        }
                    },
                    {
                        "data": "medicineName",
                        "render": function(data, type, row) {
                            return '<strong>' + (data || '') + '</strong>';
                        }
                    },
                    { "data": "quantity" },
                    {
                        "data": "returnReason",
                        "render": function(data, type, row) {
                            return renderReturnReason(data);
                        }
                    },
                    {
                        "data": "returnDestination",
                        "render": function(data, type, row) {
                            return renderReturnDestination(data);
                        }
                    },
                    {
                        "data": "returnStatus",
                        "render": function(data, type, row) {
                            return renderReturnStatus(data);
                        }
                    },
                    {
                        "data": "dateReturned",
                        "render": function(data, type, row) {
                            if (data && type === 'display') {
                                var date = new Date(data);
                                return date.toLocaleDateString('en-US', { month: 'short', day: '2-digit', year: 'numeric' });
                            }
                            return data;
                        }
                    },
                    {
                        "data": null,
                        "orderable": false,
                        "render": function (data, type, row) {
                            var detailsUrl = '@Url.Action("Details", "Return")' + '?id=' + row.id;
                            var saleDetailsUrl = '@Url.Action("Details", "Sale")' + '?id=' + row.saleId;

                            return '<div class="btn-group">' +
                                   '<button type="button" class="btn btn-purple dropdown-toggle btn-xs" data-toggle="dropdown" aria-expanded="true">' +
                                   'actions <span class="caret"></span>' +
                                   '</button>' +
                                   '<ul class="dropdown-menu" role="menu">' +
                                   '<li><a href="' + detailsUrl + '"><i class="fa fa-eye"></i> View Details</a></li>' +
                                   '<li><a href="' + saleDetailsUrl + '"><i class="fa fa-file-text"></i> View Original Sale</a></li>' +
                                   '</ul>' +
                                   '</div>';
                        }
                    }
                ],
                "pageLength": 25,
                "lengthMenu": [[10, 25, 50, 100], [10, 25, 50, 100]],
                "searching": true,
                "ordering": true,
                "info": true,
                "autoWidth": false,
                "order": [[7, 'desc']], // Sort by date returned (newest first)
                "language": {
                    "searchPlaceholder": "Search returns...",
                    "processing": '<i class="fa fa-spinner fa-spin fa-3x fa-fw"></i><span class="sr-only">Loading...</span>',
                    "emptyTable": "No returns found",
                    "zeroRecords": "No matching returns found"
                }
            });
        });
    </script>
}
