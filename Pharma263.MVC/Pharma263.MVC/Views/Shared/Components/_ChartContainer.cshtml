@model dynamic

<div class="chart-container" data-chart-id="@(ViewBag.ChartId ?? "chart")" data-chart-type="@(ViewBag.ChartType ?? "line")">
    <div class="chart-header mb-3">
        @if (!string.IsNullOrEmpty(ViewBag.ChartTitle as string))
        {
            <h6 class="chart-title">@ViewBag.ChartTitle</h6>
        }
        @if (ViewBag.ShowLegend == true)
        {
            <div class="chart-legend d-flex flex-wrap gap-3 mt-2" id="legend-@(ViewBag.ChartId ?? "chart")">
                <!-- Legend items will be populated by JavaScript -->
            </div>
        }
    </div>

    <div class="chart-wrapper position-relative">
        <!-- Loading overlay -->
        <div class="chart-loading d-none" id="chart-loading-@(ViewBag.ChartId ?? "chart")">
            <div class="d-flex justify-content-center align-items-center position-absolute w-100 h-100" style="background: rgba(255,255,255,0.8); z-index: 10;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading chart...</span>
                </div>
            </div>
        </div>

        <!-- Chart canvas -->
        <canvas id="@(ViewBag.ChartId ?? "chart")" 
                width="@(ViewBag.Width ?? 400)" 
                height="@(ViewBag.Height ?? 200)"
                style="max-height: @(ViewBag.MaxHeight ?? "400px");">
        </canvas>

        <!-- No data message -->
        <div class="no-data-message d-none text-center py-5" id="no-data-@(ViewBag.ChartId ?? "chart")">
            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
            <h6 class="text-muted">No Data Available</h6>
            <p class="text-muted small">There is no data to display for the selected period.</p>
        </div>
    </div>

    @if (ViewBag.ShowControls == true)
    {
        <div class="chart-controls mt-3">
            <div class="d-flex justify-content-between align-items-center">
                <div class="chart-type-selector">
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="chartType-@(ViewBag.ChartId ?? "chart")" id="line-@(ViewBag.ChartId ?? "chart")" value="line" checked>
                        <label class="btn btn-outline-primary" for="line-@(ViewBag.ChartId ?? "chart")">
                            <i class="fas fa-chart-line me-1"></i>Line
                        </label>

                        <input type="radio" class="btn-check" name="chartType-@(ViewBag.ChartId ?? "chart")" id="bar-@(ViewBag.ChartId ?? "chart")" value="bar">
                        <label class="btn btn-outline-primary" for="bar-@(ViewBag.ChartId ?? "chart")">
                            <i class="fas fa-chart-bar me-1"></i>Bar
                        </label>

                        <input type="radio" class="btn-check" name="chartType-@(ViewBag.ChartId ?? "chart")" id="pie-@(ViewBag.ChartId ?? "chart")" value="pie">
                        <label class="btn btn-outline-primary" for="pie-@(ViewBag.ChartId ?? "chart")">
                            <i class="fas fa-chart-pie me-1"></i>Pie
                        </label>
                    </div>
                </div>

                <div class="chart-options">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="downloadChart('@(ViewBag.ChartId ?? "chart")')">
                        <i class="fas fa-download me-1"></i>Download
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="fullscreenChart('@(ViewBag.ChartId ?? "chart")')">
                        <i class="fas fa-expand me-1"></i>Fullscreen
                    </button>
                </div>
            </div>
        </div>
    }
</div>

<style>
.chart-container {
    background: white;
    border-radius: 8px;
    padding: 1rem;
}

.chart-title {
    color: #2c3e50;
    font-weight: 600;
    margin-bottom: 0;
}

.chart-wrapper {
    min-height: 200px;
}

.chart-legend {
    font-size: 0.875rem;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
}

.chart-controls {
    border-top: 1px solid #e9ecef;
    padding-top: 1rem;
}

.no-data-message {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100%;
}
</style>

<script>
// Chart.js configuration defaults
const chartDefaults = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            display: false, // We'll create custom legends
        },
        tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: 'white',
            bodyColor: 'white',
            borderColor: 'rgba(255, 255, 255, 0.1)',
            borderWidth: 1,
            cornerRadius: 6,
            displayColors: true,
        }
    },
    scales: {
        x: {
            grid: {
                color: 'rgba(0, 0, 0, 0.05)',
            },
            ticks: {
                color: '#6c757d',
                font: {
                    size: 12
                }
            }
        },
        y: {
            grid: {
                color: 'rgba(0, 0, 0, 0.05)',
            },
            ticks: {
                color: '#6c757d',
                font: {
                    size: 12
                }
            }
        }
    }
};

// Color palette for charts
const chartColors = [
    '#667eea', '#764ba2', '#f093fb', '#f5576c', 
    '#4facfe', '#00f2fe', '#43e97b', '#38f9d7',
    '#ffecd2', '#fcb69f', '#a8edea', '#fed6e3'
];

function createChart(chartId, data, options = {}) {
    const ctx = document.getElementById(chartId);
    if (!ctx) return null;

    const config = {
        ...chartDefaults,
        ...options,
        data: data
    };

    return new Chart(ctx, config);
}

function showChartLoading(chartId) {
    const loading = document.getElementById(`chart-loading-${chartId}`);
    if (loading) loading.classList.remove('d-none');
}

function hideChartLoading(chartId) {
    const loading = document.getElementById(`chart-loading-${chartId}`);
    if (loading) loading.classList.add('d-none');
}

function showNoData(chartId) {
    const noData = document.getElementById(`no-data-${chartId}`);
    if (noData) noData.classList.remove('d-none');
}

function hideNoData(chartId) {
    const noData = document.getElementById(`no-data-${chartId}`);
    if (noData) noData.classList.add('d-none');
}

function downloadChart(chartId) {
    const canvas = document.getElementById(chartId);
    if (canvas) {
        const url = canvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = url;
        a.download = `${chartId}-chart.png`;
        a.click();
    }
}

function fullscreenChart(chartId) {
    const container = document.querySelector(`[data-chart-id="${chartId}"]`);
    if (container) {
        if (container.requestFullscreen) {
            container.requestFullscreen();
        } else if (container.webkitRequestFullscreen) {
            container.webkitRequestFullscreen();
        } else if (container.mozRequestFullScreen) {
            container.mozRequestFullScreen();
        }
    }
}
</script>