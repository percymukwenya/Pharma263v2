@model Pharma263.MVC.DTOs.StoreSettings.StoreSettingsDetailsDto
@{
    ViewBag.Title = "Store Setting";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@if (TempData["Msg"] != null)
{
    <div class="alert alert-success alert-dismissable">
        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">
            ×
        </button>
        @TempData["Msg"].ToString()
    </div>
}
@if (TempData["FMsg"] != null)
{
    <div class="alert alert-success alert-dismissable">
        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">
            ×
        </button>
        @TempData["FMsg"].ToString()
    </div>
}



<div class="wraper container-fluid">
    <div class="page-title">
        <h1 class="title">Store Setting </h1>
    </div>
    <div class="row">
        <div class="col-lg-10 col-md-offset-1">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h2 class="panel-title"> Update Store Setting</h2>
                </div>
                <div class="panel-body">
                    @using (Html.BeginForm("StoreSetting", "StoreSettings", FormMethod.Post, new { @class = "ajax-form", data_ajax = "true", data_validate = "true", data_ajax_options = "{\"showSuccess\": true, \"redirect\": \"/StoreSettings/StoreSetting\"}", enctype = "multipart/form-data" }))
                    {
                        @Html.AntiForgeryToken()
                        @Html.HiddenFor(x=> x.Id)

                        <div class="col-md-12">
                            <div class="form-group">
                                <div class="col-md-5 col-md-offset-2">
                                    @{
                                        var logoSrc = "/images/pharma263Logo.jpg"; // Default logo that we know exists
                                        // Don't use the stored logo path since it points to a file that doesn't exist
                                        // We'll let the user upload a new logo if they want to change it
                                    }
                                    
                                    <img src="@logoSrc" alt="Store Logo" id="UploadFile" class="img-thumbnail" style="height: 150px; width: 150px; object-fit: contain; border: 1px solid #ddd;" />
                                    <br />
                                    <input type="file" name="logoPostedFileBase" accept="image/*" id="FileUpload" onchange="PreviewImage()" class="form-control-file mt-2" />
                                    <small class="text-muted d-block mt-1">Upload a new logo or keep current: @(System.IO.Path.GetFileName(logoSrc))</small>
                                    @Html.HiddenFor(x => x.Logo, new { @value = logoSrc })
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            @Html.LabelFor(x => x.StoreName)
                            @Html.TextBoxFor(x => x.StoreName, null, new { @class = "form-control", @placeholder = "Enter Store Name", @required = "required" })
                            @Html.ValidationMessageFor(x => x.StoreName, "", new { @class = "text-danger" })
                        </div>

                        <div class="row">
                            <div class="col-lg-6 col-md-6">
                                <div class="form-group">
                                    @Html.LabelFor(x => x.Currency)
                                    @Html.TextBoxFor(x => x.Currency, null, new { @class = "form-control", @placeholder = "Enter Currency Symbol", @required = "required" })
                                    @Html.ValidationMessageFor(x => x.Currency, "", new { @class = "text-danger" })
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-6">
                                <div class="form-group">
                                    @Html.LabelFor(x => x.Email)
                                    @Html.TextBoxFor(x => x.Email, null, new { @class = "form-control", @placeholder = "Enter Email", @type = "email", @required = "required" })
                                    @Html.ValidationMessageFor(x => x.Email, "", new { @class = "text-danger" })
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            @Html.LabelFor(x => x.Phone)
                            @Html.TextBoxFor(x => x.Phone, null, new { @class = "form-control", @placeholder = "Enter Phone Number", data_rule_phone = "true", @required = "required" })
                            @Html.ValidationMessageFor(x => x.Phone, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group">
                            @Html.LabelFor(x => x.Address)
                            @Html.TextAreaFor(x => x.Address, new { @class = "form-control", @rows = "3", @placeholder = "Store Address", @required = "required" })
                            @Html.ValidationMessageFor(x => x.Address, "", new { @class = "text-danger" })
                        </div>

                        <div class="row">
                            <div class="col-lg-6 col-md-6">
                                <div class="form-group">
                                    @Html.LabelFor(x => x.MCAZLicence)
                                    @Html.TextBoxFor(x => x.MCAZLicence, null, new { @class = "form-control", @placeholder = "MCAZ License", data_rule_mcaz = "true" })
                                    @Html.ValidationMessageFor(x => x.MCAZLicence, "", new { @class = "text-danger" })
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-6">
                                <div class="form-group">
                                    @Html.LabelFor(x => x.VATNumber)
                                    @Html.TextBoxFor(x => x.VATNumber, null, new { @class = "form-control", @placeholder = "VAT Number", data_rule_vat = "true" })
                                    @Html.ValidationMessageFor(x => x.VATNumber, "", new { @class = "text-danger" })
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            @Html.LabelFor(x => x.BankingDetails)
                            @Html.TextAreaFor(x => x.BankingDetails, new { @class = "form-control", @rows = "4", @placeholder = "Enter banking details (e.g., Account Name, Bank, Branch, Account Number)" })
                            @Html.ValidationMessageFor(x => x.BankingDetails, "", new { @class = "text-danger" })
                            <small class="text-muted">This information will appear on your sales invoices. Use line breaks for formatting.</small>
                        </div>

                        <div class="form-group">
                            @Html.LabelFor(x => x.ReturnsPolicy)
                            @Html.TextAreaFor(x => x.ReturnsPolicy, new { @class = "form-control", @rows = "4", @placeholder = "Enter your returns policy" })
                            @Html.ValidationMessageFor(x => x.ReturnsPolicy, "", new { @class = "text-danger" })
                            <button id="formatReturnsPolicy" class="btn btn-xs btn-default mt-1">Format as numbered list</button>
                            <small class="text-muted">Format as numbered points (e.g., 1. Any returns must be within seven days...)</small>
                        </div>

                        <div class="form-group">
                            <button type="submit" class="btn btn-purple btn-lg">
                                Update Store Settings
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>

    </div>
</div>

@section scripts{
    <script type="text/javascript">
        $(document).ready(function () {
            // Enable real-time validation
            if (window.Pharma263) {
                window.Pharma263.enableRealtimeValidation($('.ajax-form'));
            }

            // Auto-format store name to title case
            $('#StoreName').on('blur', function() {
                const value = $(this).val();
                if (value) {
                    $(this).val(value.toLowerCase().replace(/\b\w/g, l => l.toUpperCase()));
                }
            });

            // Format currency symbol
            $('#Currency').on('blur', function() {
                const value = $(this).val();
                if (value && value.length === 1) {
                    // If single character, it's likely a currency symbol, keep as is
                    $(this).val(value);
                } else if (value && value.length > 1) {
                    // If multiple characters, convert to uppercase
                    $(this).val(value.toUpperCase());
                }
            });

            // Validate and format license numbers
            $('#MCAZLicence').on('blur', function() {
                const value = $(this).val().toUpperCase();
                $(this).val(value);
                
                if (value && window.Pharma263Utils) {
                    if (!window.Pharma263Utils.validateLicense(value, 'MCAZ')) {
                        if (window.Pharma263) {
                            window.Pharma263.showToast('Please check MCAZ license format', 'warning');
                        }
                    }
                }
            });

            // Validate VAT number
            $('#VATNumber').on('blur', function() {
                const value = $(this).val().toUpperCase();
                $(this).val(value);
                
                if (value && window.Pharma263Utils) {
                    if (!window.Pharma263Utils.validateLicense(value, 'VAT')) {
                        if (window.Pharma263) {
                            window.Pharma263.showToast('Please check VAT number format', 'warning');
                        }
                    }
                }
            });

            // Auto-format addresses
            $('#Address').on('blur', function() {
                const value = $(this).val();
                if (value) {
                    // Capitalize first letter of each line
                    const formatted = value.split('\n').map(line => 
                        line.charAt(0).toUpperCase() + line.slice(1)
                    ).join('\n');
                    $(this).val(formatted);
                }
            });

            // Format returns policy button
            $("#formatReturnsPolicy").click(function(e) {
                e.preventDefault();
                var policyText = $("#ReturnsPolicy").val().trim();

                // Split by lines and format each line with a number if not already numbered
                var lines = policyText.split('\n');
                var formattedLines = [];

                for (var i = 0; i < lines.length; i++) {
                    var line = lines[i].trim();
                    if (line) {
                        // Check if line already starts with a number followed by period
                        if (!/^\d+\./.test(line)) {
                            formattedLines.push((i+1) + ". " + line);
                        } else {
                            formattedLines.push(line);
                        }
                    }
                }

                $("#ReturnsPolicy").val(formattedLines.join('\n'));
            });

            // Success callback for form submission
            $(document).on('ajaxSuccess', '.ajax-form', function(event, xhr, settings) {
                if (settings.url.includes('StoreSetting')) {
                    console.log('Store settings updated successfully');
                }
            });
        });

        function PreviewImage() {
            var oFReader = new FileReader();
            oFReader.readAsDataURL(document.getElementById("FileUpload").files[0]);

            oFReader.onload = function (oFREvent) {
                document.getElementById("UploadFile").src = oFREvent.target.result;
            };
        };
    </script>
}
