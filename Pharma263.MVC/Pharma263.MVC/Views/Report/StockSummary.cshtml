@{
    ViewData["Title"] = "Stock Summary Report";
}

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Stock Summary Report</h2>
        <a href="@Url.Action("Index", "Report")" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Reports
        </a>
    </div>

    <div class="row">
        <!-- Parameters Card -->
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">Report Parameters</h5>
                    <form id="reportForm">
                        <div class="mb-3">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate" name="startDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="endDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="endDate" name="endDate" required>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="button" onclick="generateReport('preview')" class="btn btn-primary">
                                <i class="fas fa-search me-2"></i>Generate Report
                            </button>
                            <button type="button" onclick="generateReport('pdf')" class="btn btn-secondary">
                                <i class="fas fa-file-pdf me-2"></i>Export PDF
                            </button>
                            <button type="button" onclick="generateReport('csv')" class="btn btn-secondary">
                                <i class="fas fa-file-csv me-2"></i>Export CSV
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Stock Summary Card -->
            <div class="card shadow-sm mt-3">
                <div class="card-body">
                    <h5 class="card-title mb-3">Quick Stats</h5>
                    <div class="d-flex align-items-center mb-2">
                        <div class="bg-success rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                        <span>In Stock</span>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="bg-warning rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                        <span>Low Stock</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="bg-danger rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                        <span>Out of Stock</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Container -->
        <div class="col-md-9">
            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <h6 class="card-title">Total Items</h6>
                            <h3 id="totalItems">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <h6 class="card-title">In Stock</h6>
                            <h3 id="inStockItems">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning">
                        <div class="card-body">
                            <h6 class="card-title">Low Stock</h6>
                            <h3 id="lowStockItems">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <h6 class="card-title">Out of Stock</h6>
                            <h3 id="outOfStockItems">0</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Results -->
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Stock Summary Details</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="stockTable">
                            <thead>
                                <tr>
                                    <th scope="col">Product Code</th>
                                    <th scope="col">Product Name</th>
                                    <th scope="col">Current Stock</th>
                                    <th scope="col">Reorder Level</th>
                                    <th scope="col">Unit Cost</th>
                                    <th scope="col">Total Value</th>
                                    <th scope="col">Stock Status</th>
                                    <th scope="col">Last Movement</th>
                                </tr>
                            </thead>
                            <tbody id="reportData">
                                <tr>
                                    <td colspan="8" class="text-center text-muted">
                                        <i class="fas fa-info-circle me-2"></i>Select date range and click "Generate Report" to view stock summary
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function generateReport(format) {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }

            if (format === 'preview') {
                $.post('@Url.Action("StockTurnover")',
                    { startDate, endDate },
                    function (data) {
                        if (data && data.length > 0) {
                            displayReport(data);
                        } else {
                            displayNoData();
                        }
                    });
            } else if (format === 'pdf') {
                window.location.href = `@Url.Action("DownloadStockSummaryPDF")?startDate=${startDate}&endDate=${endDate}`;
            } else if (format === 'csv') {
                window.location.href = `@Url.Action("DownloadStockSummaryCSV")?startDate=${startDate}&endDate=${endDate}`;
            }
        }

        function displayReport(data) {
            updateSummaryCards(data);
            displayDetailedResults(data);
        }

        function updateSummaryCards(data) {
            const totalItems = data.length;
            const inStock = data.filter(item => item.currentStock > item.reorderLevel).length;
            const lowStock = data.filter(item => item.currentStock <= item.reorderLevel && item.currentStock > 0).length;
            const outOfStock = data.filter(item => item.currentStock === 0).length;

            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('inStockItems').textContent = inStock;
            document.getElementById('lowStockItems').textContent = lowStock;
            document.getElementById('outOfStockItems').textContent = outOfStock;
        }

        function displayDetailedResults(data) {
            const tbody = document.getElementById('reportData');
            tbody.innerHTML = '';

            data.forEach(item => {
                const stockStatus = getStockStatus(item.currentStock, item.reorderLevel);
                const statusBadge = getStatusBadge(stockStatus);
                
                tbody.innerHTML += `
                    <tr>
                        <td>${item.productCode}</td>
                        <td>${item.productName}</td>
                        <td>${item.currentStock}</td>
                        <td>${item.reorderLevel}</td>
                        <td>$${item.unitCost ? item.unitCost.toFixed(2) : '0.00'}</td>
                        <td>$${(item.currentStock * (item.unitCost || 0)).toFixed(2)}</td>
                        <td>${statusBadge}</td>
                        <td>${item.lastMovementDate ? new Date(item.lastMovementDate).toLocaleDateString() : 'N/A'}</td>
                    </tr>
                `;
            });
        }

        function getStockStatus(currentStock, reorderLevel) {
            if (currentStock === 0) return 'Out of Stock';
            if (currentStock <= reorderLevel) return 'Low Stock';
            return 'In Stock';
        }

        function getStatusBadge(status) {
            switch (status) {
                case 'In Stock':
                    return '<span class="badge bg-success">In Stock</span>';
                case 'Low Stock':
                    return '<span class="badge bg-warning">Low Stock</span>';
                case 'Out of Stock':
                    return '<span class="badge bg-danger">Out of Stock</span>';
                default:
                    return '<span class="badge bg-secondary">Unknown</span>';
            }
        }

        function displayNoData() {
            document.getElementById('reportData').innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-muted">
                        <i class="fas fa-exclamation-circle me-2"></i>No stock data found for the selected date range
                    </td>
                </tr>
            `;
        }

        // Set default dates
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
        });
    </script>
}