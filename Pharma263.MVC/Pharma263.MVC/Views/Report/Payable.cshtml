@{
    ViewData["Title"] = "Accounts Payable Report";
}

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Accounts Payable Report</h2>
        <a href="@Url.Action("Index", "Report")" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Reports
        </a>
    </div>

    <div class="row">
        <!-- Parameters Card -->
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">Report Parameters</h5>
                    <form id="reportForm">
                        <div class="mb-3">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate" name="startDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="endDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="endDate" name="endDate" required>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="button" onclick="generateReport('preview')" class="btn btn-primary">
                                <i class="fas fa-search me-2"></i>Generate Report
                            </button>
                            <button type="button" onclick="generateReport('pdf')" class="btn btn-secondary">
                                <i class="fas fa-file-pdf me-2"></i>Export PDF
                            </button>
                            <button type="button" onclick="generateReport('csv')" class="btn btn-secondary">
                                <i class="fas fa-file-csv me-2"></i>Export CSV
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Payment Status Card -->
            <div class="card shadow-sm mt-3">
                <div class="card-body">
                    <h5 class="card-title mb-3">Payment Status</h5>
                    <div class="d-flex align-items-center mb-2">
                        <div class="bg-success rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                        <span>Paid</span>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="bg-warning rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                        <span>Due Soon</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="bg-danger rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                        <span>Overdue</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Container -->
        <div class="col-md-9">
            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <h6 class="card-title">Total Payable</h6>
                            <h3 id="totalPayable">$0.00</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <h6 class="card-title">Paid</h6>
                            <h3 id="paidAmount">$0.00</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning">
                        <div class="card-body">
                            <h6 class="card-title">Due Soon</h6>
                            <h3 id="dueSoonAmount">$0.00</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <h6 class="card-title">Overdue</h6>
                            <h3 id="overdueAmount">$0.00</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Results -->
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Accounts Payable Details</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="payableTable">
                            <thead>
                                <tr>
                                    <th>Supplier</th>
                                    <th>Amount Owing</th>
                                    <th>Due Date</th>
                                    <th>Days Until Due</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="reportData">
                                <tr>
                                    <td colspan="5" class="text-center text-muted">
                                        <i class="fas fa-info-circle me-2"></i>Select date range and click "Generate Report" to view payables
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function generateReport(format) {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }

            if (format === 'preview') {
                $.post('@Url.Action("AccountsPayableReport")',
                    { startDate, endDate },
                    function (data) {
                        if (data && data.length > 0) {
                            displayReport(data);
                        } else {
                            displayNoData();
                        }
                    });
            } else if (format === 'pdf') {
                window.location.href = `@Url.Action("DownloadAccountsPayablePDF")?startDate=${startDate}&endDate=${endDate}`;
            } else if (format === 'csv') {
                window.location.href = `@Url.Action("DownloadAccountsPayableCSV")?startDate=${startDate}&endDate=${endDate}`;
            }
        }

        function displayReport(data) {
            updateSummaryCards(data);
            displayDetailedResults(data);
        }

        function updateSummaryCards(data) {
            const total = data.reduce((sum, item) => sum + (item.amountOwing || 0), 0);
            const dueSoon = data.filter(item => getDaysUntilDue(item.dueDate) > 0 && getDaysUntilDue(item.dueDate) <= 7).reduce((sum, item) => sum + (item.amountOwing || 0), 0);
            const overdue = data.filter(item => getDaysUntilDue(item.dueDate) < 0).reduce((sum, item) => sum + (item.amountOwing || 0), 0);
            const outstanding = total - overdue - dueSoon;

            document.getElementById('totalPayable').textContent = `$${total.toFixed(2)}`;
            document.getElementById('paidAmount').textContent = `$${outstanding.toFixed(2)}`;
            document.getElementById('dueSoonAmount').textContent = `$${dueSoon.toFixed(2)}`;
            document.getElementById('overdueAmount').textContent = `$${overdue.toFixed(2)}`;
        }

        function displayDetailedResults(data) {
            const tbody = document.getElementById('reportData');
            tbody.innerHTML = '';

            data.forEach(item => {
                const daysUntilDue = getDaysUntilDue(item.dueDate);
                const paymentStatus = getPaymentStatus(daysUntilDue);
                const statusBadge = getPaymentBadge(paymentStatus);
                
                tbody.innerHTML += `
                    <tr>
                        <td>${item.supplierName || 'N/A'}</td>
                        <td>$${item.amountOwing ? item.amountOwing.toFixed(2) : '0.00'}</td>
                        <td>${item.dueDate ? new Date(item.dueDate).toLocaleDateString() : 'N/A'}</td>
                        <td>${daysUntilDue}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            });
        }

        function getDaysUntilDue(dueDateStr) {
            const dueDate = new Date(dueDateStr);
            const today = new Date();
            const timeDiff = dueDate.getTime() - today.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            return daysDiff;
        }

        function getPaymentStatus(daysUntilDue) {
            if (daysUntilDue < 0) return 'Overdue';
            if (daysUntilDue <= 7) return 'Due Soon';
            return 'Outstanding';
        }

        function getPaymentBadge(status) {
            switch (status) {
                case 'Paid':
                    return '<span class="badge bg-success">Paid</span>';
                case 'Due Soon':
                    return '<span class="badge bg-warning">Due Soon</span>';
                case 'Overdue':
                    return '<span class="badge bg-danger">Overdue</span>';
                case 'Outstanding':
                    return '<span class="badge bg-info">Outstanding</span>';
                default:
                    return '<span class="badge bg-secondary">Unknown</span>';
            }
        }

        function displayNoData() {
            document.getElementById('reportData').innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-muted">
                        <i class="fas fa-exclamation-circle me-2"></i>No payable data found for the selected date range
                    </td>
                </tr>
            `;
        }

        // Set default dates
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
        });
    </script>
}