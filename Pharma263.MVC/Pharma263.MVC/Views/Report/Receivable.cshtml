@{
    ViewData["Title"] = "Accounts Receivable Report";
}

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Accounts Receivable Report</h2>
        <a href="@Url.Action("Index", "Report")" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Reports
        </a>
    </div>

    <div class="row">
        <!-- Parameters Card -->
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">Report Parameters</h5>
                    <form id="reportForm">
                        <div class="mb-3">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate" name="startDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="endDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="endDate" name="endDate" required>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="button" onclick="generateReport('preview')" class="btn btn-primary">
                                <i class="fas fa-search me-2"></i>Generate Report
                            </button>
                            <button type="button" onclick="generateReport('pdf')" class="btn btn-secondary">
                                <i class="fas fa-file-pdf me-2"></i>Export PDF
                            </button>
                            <button type="button" onclick="generateReport('csv')" class="btn btn-secondary">
                                <i class="fas fa-file-csv me-2"></i>Export CSV
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Aging Summary Card -->
            <div class="card shadow-sm mt-3">
                <div class="card-body">
                    <h5 class="card-title mb-3">Aging Summary</h5>
                    <div class="d-flex align-items-center mb-2">
                        <div class="bg-success rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                        <span>Current (0-30 days)</span>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="bg-warning rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                        <span>31-60 days</span>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="bg-orange rounded-circle me-2" style="width: 12px; height: 12px; background-color: orange;"></div>
                        <span>61-90 days</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="bg-danger rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                        <span>Over 90 days</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Container -->
        <div class="col-md-9">
            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <h6 class="card-title">Total Outstanding</h6>
                            <h3 id="totalOutstanding">$0.00</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <h6 class="card-title">Current (0-30)</h6>
                            <h3 id="currentAmount">$0.00</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning">
                        <div class="card-body">
                            <h6 class="card-title">31-60 Days</h6>
                            <h3 id="aging30to60">$0.00</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <h6 class="card-title">Over 90 Days</h6>
                            <h3 id="agingOver90">$0.00</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Results -->
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Accounts Receivable Details</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="receivableTable">
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Amount Owing</th>
                                    <th>Due Date</th>
                                    <th>Days Overdue</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="reportData">
                                <tr>
                                    <td colspan="5" class="text-center text-muted">
                                        <i class="fas fa-info-circle me-2"></i>Select date range and click "Generate Report" to view receivables
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function generateReport(format) {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }

            if (format === 'preview') {
                $.post('@Url.Action("AccountsReceivableReport")',
                    { startDate, endDate },
                    function (data) {
                        if (data && data.length > 0) {
                            displayReport(data);
                        } else {
                            displayNoData();
                        }
                    });
            } else if (format === 'pdf') {
                window.location.href = `@Url.Action("DownloadAccountsReceivablePDF")?startDate=${startDate}&endDate=${endDate}`;
            } else if (format === 'csv') {
                window.location.href = `@Url.Action("DownloadAccountsReceivableCSV")?startDate=${startDate}&endDate=${endDate}`;
            }
        }

        function displayReport(data) {
            updateSummaryCards(data);
            displayDetailedResults(data);
        }

        function updateSummaryCards(data) {
            const total = data.reduce((sum, item) => sum + (item.amountOwing || 0), 0);
            const current = data.filter(item => getDaysOverdue(item.dueDate) <= 30).reduce((sum, item) => sum + (item.amountOwing || 0), 0);
            const aging30to60 = data.filter(item => getDaysOverdue(item.dueDate) > 30 && getDaysOverdue(item.dueDate) <= 60).reduce((sum, item) => sum + (item.amountOwing || 0), 0);
            const agingOver90 = data.filter(item => getDaysOverdue(item.dueDate) > 90).reduce((sum, item) => sum + (item.amountOwing || 0), 0);

            document.getElementById('totalOutstanding').textContent = `$${total.toFixed(2)}`;
            document.getElementById('currentAmount').textContent = `$${current.toFixed(2)}`;
            document.getElementById('aging30to60').textContent = `$${aging30to60.toFixed(2)}`;
            document.getElementById('agingOver90').textContent = `$${agingOver90.toFixed(2)}`;
        }

        function displayDetailedResults(data) {
            const tbody = document.getElementById('reportData');
            tbody.innerHTML = '';

            data.forEach(item => {
                const daysOverdue = getDaysOverdue(item.dueDate);
                const agingStatus = getAgingStatus(daysOverdue);
                const statusBadge = getAgingBadge(agingStatus);
                
                tbody.innerHTML += `
                    <tr>
                        <td>${item.customerName || 'N/A'}</td>
                        <td>$${item.amountOwing ? item.amountOwing.toFixed(2) : '0.00'}</td>
                        <td>${item.dueDate ? new Date(item.dueDate).toLocaleDateString() : 'N/A'}</td>
                        <td>${daysOverdue}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            });
        }

        function getAgingStatus(daysOverdue) {
            if (daysOverdue <= 30) return 'Current';
            if (daysOverdue <= 60) return '31-60 Days';
            if (daysOverdue <= 90) return '61-90 Days';
            return 'Over 90 Days';
        }

        function getAgingBadge(status) {
            switch (status) {
                case 'Current':
                    return '<span class="badge bg-success">Current</span>';
                case '31-60 Days':
                    return '<span class="badge bg-warning">31-60 Days</span>';
                case '61-90 Days':
                    return '<span class="badge" style="background-color: orange;">61-90 Days</span>';
                case 'Over 90 Days':
                    return '<span class="badge bg-danger">Over 90 Days</span>';
                default:
                    return '<span class="badge bg-secondary">Unknown</span>';
            }
        }

        function getDaysOverdue(dueDateStr) {
            const dueDate = new Date(dueDateStr);
            const today = new Date();
            const timeDiff = today.getTime() - dueDate.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            return Math.max(0, daysDiff);
        }

        function displayNoData() {
            document.getElementById('reportData').innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-muted">
                        <i class="fas fa-exclamation-circle me-2"></i>No receivable data found for the selected date range
                    </td>
                </tr>
            `;
        }

        // Set default dates
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
        });
    </script>
}