@using Pharma263.MVC.Enums;
@using System.ComponentModel;
@model int
@{
    ViewBag.Title = "Edit Purchase";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@* Inline styles moved to /css/modules/common-overrides.css, forms.css, and purchases.css *@
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />

<div class="wraper container-fluid">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Edit Purchase</h3>
            </div>
            <div class="panel-body" id="master">
                <!-- Supplier and Date Section -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="Supplier">Supplier : </label>
                            <select id="Supplier" class="form-control" onchange="blankme(this.id)">
                                <option value="">Select Supplier</option>
                            </select>
                            <small id="error_Supplier" class="form-text error_msg">Select supplier from list</small>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="Date">Purchase Date : </label>
                            @Html.TextBox("Date", null, new { @class = "form-control mydatepicker", @placeholder = "Select Purchase Date", onchange = "blankme(this.id)" })
                            <small id="error_Date" class="form-text error_msg">Purchase Date is Required</small>
                        </div>
                    </div>
                </div>

                <!-- Product Section - Improved Layout -->
                <div class="product-section">
                    <!-- Product Selection Form -->
                    <div class="product-form">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title">Add Item</h3>
                            </div>
                            <div class="panel-body">
                                <form role="form">
                                    <div class="form-group">
                                        <label for="Medicine">Medicine : </label>
                                        <select id="Medicine" class="form-control">
                                            <option value="">Select Medicine</option>
                                        </select>
                                        <small id="error_Medicine" class="form-text error_msg">Select Medicine from list</small>
                                    </div>
                                    <div class="form-group" id="medicineDetails">
                                        <!-- Medicine details will be populated here -->
                                    </div>
                                    <div class="form-group">
                                        <label for="Quantity">Quantity : </label>
                                        @Html.TextBox("Quantity", null, new { @class = "form-control", @type = "number", @placeholder = "Enter Quantity", @min = "0" })
                                        <small id="error_Quantity" class="form-text error_msg">Quantity is required</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="DiscountPercent">Discount % : </label>
                                        @Html.TextBox("DiscountPercent", null, new { @class = "form-control", @type = "number", @placeholder = "Enter Discount %", @min = "0", @max = "100", @step = "0.01" })
                                        <small id="error_DiscountPercent" class="form-text error_msg">Discount must be between 0-100%</small>
                                    </div>
                                    <div class="form-group">
                                        <button type="submit" id="addToList" class="btn btn-info btn-block">
                                            Add To List
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Product List -->
                    <div class="product-list">
                        <div class="panel panel-color panel-primary">
                            <div class="panel-heading">
                                <h3 class="panel-title">Product List</h3>
                            </div>
                            <div class="panel-body">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="detailsTable">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Name</th>
                                                <th>Batch No</th>
                                                <th>Expiry</th>
                                                <th>Buying $</th>
                                                <th>Selling $</th>
                                                <th>Discount %</th>
                                                <th>Qty</th>
                                                <th>Amount</th>
                                                <th style="width:20px"></th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                        <tfoot>
                                            <tr>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td></td>
                                                <td><strong>Total:</strong></td>
                                                <td><strong id="SubTotal"></strong></td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <small id="error_SubTotal" class="form-text error_msg">At least add one item</small>
                            </div>
                        </div>

                        <!-- Purchase Details Section -->
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label for="Notes">Notes: </label>
                                    @Html.TextArea("Notes", new { @class = "form-control", @rows = "2", @placeholder = "Enter Notes" })
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="PaymentMethod">Payment Method : </label>
                                            <select id="PaymentMethod" class="form-control" onchange="blankme(this.id)">
                                                <option value="">Select Payment Method</option>
                                            </select>
                                            <small id="error_Payment" class="form-text error_msg">Select Payment Method</small>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="PurchaseStatus">Purchase Status : </label>
                                            <select id="PurchaseStatus" class="form-control" onchange="blankme(this.id)">
                                                <option value="">Select Purchase Status</option>
                                            </select>
                                            <small id="error_PurchaseStatus" class="form-text error_msg">Select Purchase Status</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="Discount">Discount : </label>
                                    @Html.TextBox("Discount", null, new { @class = "form-control", @Value = "0", @type = "number", @placeholder = "Discount Amount", onchange = "DiscountAmount()" })
                                    <small id="error_Discount" class="form-text error_msg">Discount can't be empty</small>
                                </div>
                                <div class="form-group">
                                    <label for="GrandTotal">Grand Total : </label>
                                    <h5 id="GrandTotal" class="form-control"></h5>
                                    <small id="error_GrandTotal" class="form-text error_msg">Total is empty</small>
                                </div>

                                <div class="form-group">
                                    <input id="BtnUpdate" data-purchase-id="@Model" class="btn btn-primary btn-block" type="submit" value="Update Purchase" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


@section scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Include jQuery UI library -->
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="~/Scripts/App/App.js"></script>

    <script type="text/javascript">
        $(function () {

            var purchaseId = $("#BtnUpdate").attr("data-purchase-id");

            $('#master').ready(function () {
                //e.preventDefault();
                $.when(getPurchase(purchaseId)).then(function (res) {

                    console.log(res);
                    var detArr = [];
                    $("#Supplier").val(res.supplierId);
                    var parts = res.purchaseDate.split(" ")[0].split("-");
                    var year = parseInt(parts[0]);
                    var month = parseInt(parts[1]);
                    var day = parseInt(parts[2]);
                    var value = new Date(year, month - 1, day); // Note: month is zero-based in JavaScript
                    var ret = (day < 10 ? "0" + day : day) + "/" + (month < 10 ? "0" + month : month) + "/" + year;
                    $("#Date").val(ret);
                    $("#Notes").val(res.notes);
                    $("#PaymentMethod").val(res.paymentMethodId);
                    $("#PurchaseStatus").val(res.purchaseStatusId);
                    $("#SubTotal").text(res.total);
                    $("#Discount").val(res.discount);
                    $("#GrandTotal").text(res.grandTotal);
                    
                    $.each(res.items, function (i, v) {
                        const formattedExpiryDate = formatDate(v.expiryDate);
                        const buyingPriceFormatted = parseFloat(v.buyingPrice).toFixed(2);
                        const sellingPriceFormatted = parseFloat(v.sellingPrice).toFixed(2);
                        const amountFormatted = parseFloat(v.amount).toFixed(2);

                        // Calculate discount percentage from amount
                        var totalItemValue = v.buyingPrice * v.quantity;
                        var discountPercent = 0;
                        if (totalItemValue > 0) {
                            discountPercent = (v.discount / totalItemValue) * 100;
                        }
                        const discountPercentFormatted = discountPercent.toFixed(2);

                        var rowHtml =
                            '<tr>' +
                            '<td>' + v.medicineId + '</td>' +
                            '<td>' + v.medicineName + '</td>' +
                            '<td><input type="text" value="' + v.batchNo + '" style="width:100px;" /></td>' +
                            '<td><input type="text" value="' + formattedExpiryDate + '" style="width:80px;" /></td>' +
                            '<td><input type="text" value="' + buyingPriceFormatted + '" class="buyingPrice" style="width:50px;" /></td>' +
                            '<td><input type="text" value="' + sellingPriceFormatted + '" style="width:50px;" /></td>' +
                            '<td><input type="text" value="' + discountPercentFormatted + '" class="discountPercent" style="width:50px;" placeholder="%" /></td>' + // Show discount as percentage
                            '<td class="quantity">' + v.quantity + '</td>' +
                            '<td class="amount">' + amountFormatted + '</td>' +
                            '<td class="discountAmount" style="display:none;">' + parseFloat(v.discount).toFixed(2) + '</td>' + // Hidden discount amount
                            '<td><a data-itemId="' + v.id + '" href="#" class="deleteItem"><i class="fa fa-trash"></i></a></td>' +
                            '</tr>';
                        $("#detailsTable tbody").append(rowHtml);
                    });
                    $("#detailsTable tbody").append(detArr);

                    // Bind input events after adding rows
                    $("#detailsTable tbody tr").each(function () {
                        $(this).find(".buyingPrice, .discountPercent").on("input", function () {
                            recalcRowAmount($(this).closest("tr"));
                        });
                    });

                    //$("#orderMasterId").val(res.result.MasterId);
                    function getEnumValueByDescription(description, dropdownId) {
                        var options = $("#" + dropdownId + " option");
                        for (var i = 0; i < options.length; i++) {
                            if (options[i].text === description) {
                                return options[i].value;
                            }
                        }
                        return null;
                    }

                }).fail(function (err) {
                    console.log(err);
                });
            });
            function getPurchase(id) {
                return $.ajax({
                    type: 'GET',
                    url: "/Purchase/GetPurchase",
                    data: "purchaseId=" + id
                });
            }

            function formatDate(inputDate) {
                const date = new Date(inputDate);

                // Extract the individual date components
                const day = date.getDate();
                const month = date.getMonth() + 1; // Months are zero-based, so we add 1
                const year = date.getFullYear();

                // Pad the day and month with leading zeros if needed
                const formattedDay = day < 10 ? '0' + day : day;
                const formattedMonth = month < 10 ? '0' + month : month;

                // Combine the date components into the desired format
                return `${formattedDay}/${formattedMonth}/${year}`;
            }

            function recalcRowAmount(row) {
                // Column indexes: 4 = buying price, 6 = discount, 7 = quantity, 8 = amount
                var bp = parseFloat(row.find("td:eq(4) input").val());
                var qty = parseInt(row.find("td:eq(7)").text());
                var discPercent = parseFloat(row.find("td:eq(6) input").val());
                if (isNaN(bp)) bp = 0;
                if (isNaN(qty)) qty = 0;
                if (isNaN(discPercent)) discPercent = 0;

                // Calculate discount amount from percentage
                var discAmount = (bp * qty) * (discPercent / 100);
                if (discAmount < 0) discAmount = 0;

                var newAmt = (bp * qty) - discAmount;
                if (newAmt < 0) newAmt = 0;

                row.find("td.amount").text(newAmt.toFixed(2));

                // Update the hidden discount amount
                if (row.find("td.discountAmount").length > 0) {
                    row.find("td.discountAmount").text(discAmount.toFixed(2));
                } else {
                    // If the hidden cell doesn't exist yet, add it
                    row.append($("<td>").addClass("discountAmount").css("display", "none").text(discAmount.toFixed(2)));
                }

                calculateSum();
            }

            // Bind input events on the existing table rows (if not already bound)
            $(document).on("input", "td:eq(4) input, td:eq(6) input", function () {
                var row = $(this).closest("tr");
                recalcRowAmount(row);
            });
        });
    </script>

    }