@model Pharma263.Integration.Api.Models.Response.SupplierStatementResponse

@{
    ViewData["Title"] = "Supplier Statement";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="wraper container-fluid">
    <!-- Statement Header -->
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h2 class="panel-title">
                        <i class="fa fa-file-text-o"></i> Supplier Account Statement
                        <div class="pull-right">
                            <button onclick="window.print()" class="btn btn-primary btn-sm">
                                <i class="fa fa-print"></i> Print
                            </button>
                            <a href="@Url.Action("DownloadSupplierStatementPdf", new { supplierId = Model.SupplierId, startDate = ViewBag.StartDate, endDate = ViewBag.EndDate })" 
                               class="btn btn-success btn-sm">
                                <i class="fa fa-download"></i> Download PDF
                            </a>
                        </div>
                    </h2>
                </div>
                <div class="panel-body">
                    <!-- Date Range Selector -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <form id="dateRangeForm" class="form-inline">
                                <div class="form-group">
                                    <label for="startDate">From:</label>
                                    <input type="date" id="startDate" name="startDate" value="@ViewBag.StartDate" class="form-control" />
                                </div>
                                <div class="form-group" style="margin-left: 10px;">
                                    <label for="endDate">To:</label>
                                    <input type="date" id="endDate" name="endDate" value="@ViewBag.EndDate" class="form-control" />
                                </div>
                                <button type="button" id="refreshStatement" class="btn btn-info" style="margin-left: 10px;">
                                    <i class="fa fa-refresh"></i> Refresh
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Statement Content -->
                    <div id="statementContent">
                        @Html.Partial("_SupplierStatementPartial", Model)
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Back Navigation -->
    <div class="row">
        <div class="col-md-12">
            <a href="@Url.Action("Index", "AccountsPayable")" class="btn btn-default">
                <i class="fa fa-arrow-left"></i> Back to Accounts Payable
            </a>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Handle date range refresh
            $('#refreshStatement').on('click', function () {
                var startDate = $('#startDate').val();
                var endDate = $('#endDate').val();
                var supplierId = @Model.SupplierId;

                if (!startDate || !endDate) {
                    alert('Please select both start and end dates.');
                    return;
                }

                if (new Date(startDate) > new Date(endDate)) {
                    alert('Start date cannot be later than end date.');
                    return;
                }

                // Show loading indicator
                $('#statementContent').html('<div class="text-center"><i class="fa fa-spinner fa-spin"></i> Loading...</div>');

                $.ajax({
                    url: '@Url.Action("RefreshSupplierStatement")',
                    type: 'POST',
                    data: {
                        supplierId: supplierId,
                        startDate: startDate,
                        endDate: endDate
                    },
                    success: function (response) {
                        $('#statementContent').html(response);
                    },
                    error: function () {
                        $('#statementContent').html('<div class="alert alert-danger">Failed to refresh statement. Please try again.</div>');
                    }
                });
            });

            // Print styles
            var printStyles = `
                <style type="text/css" media="print">
                    .no-print { display: none !important; }
                    .panel { border: none !important; box-shadow: none !important; }
                    .panel-heading { background: none !important; border: none !important; }
                    body { font-size: 12px; }
                    .table { font-size: 11px; }
                    @@page { margin: 0.5in; }
                </style>
            `;
            $('head').append(printStyles);
        });
    </script>
}